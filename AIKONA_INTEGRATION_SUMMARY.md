# Интеграция с API Айконы - Краткое описание

## Что реализовано

### Backend
1. **База данных:**
   - Добавлено поле `aikona_object_id` в таблицу `objects`
   - Файл миграции: `backend/database/migrations/001_add_aikona_object_id.sql`

2. **Сервис синхронизации:**
   - Файл: `backend/services/aikona-sync.js`
   - Функции:
     - `fetchAikonaObjectData(objectId)` - получение данных из API Айконы
     - `findMatchingSTK(smrName, stks)` - сопоставление СМР по названию (с учетом экранированных кавычек)
     - `countCompletedLocations(locations)` - подсчет локаций с SZCompletion === 100
     - `syncObjectFromAikona(object)` - основная функция синхронизации

3. **API Endpoint:**
   - `POST /api/containers/:containerId/objects/:objectId/sync-aikona`
   - Синхронизирует данные объекта из Айконы
   - Обработка ошибок: OBJECT_NOT_FOUND, API_UNAVAILABLE, AIKONA_ID_NOT_SET

### Frontend
1. **ObjectModal:**
   - Добавлено поле "ID объекта в Айконе" (только для админа)
   - Кнопка "Забрать данные" с индикатором загрузки
   - Функция `handleSyncAikona()` для синхронизации
   - Обработка ошибок с понятными сообщениями

2. **API Service:**
   - Функция `syncObjectFromAikona(containerId, objectId)` в `services/api-containers.js`

## Как использовать

1. **Для первого объекта "Универ сити":**
   - Откройте объект для редактирования
   - В поле "ID объекта в Айконе" введите: `401`
   - Нажмите кнопку "Забрать данные"
   - Система запросит данные из API Айконы и обновит поле `total` для каждого СМР

2. **Логика работы:**
   - Система ищет СМР в данных Айконы по точному совпадению названия
   - Для каждого найденного СМР считает количество локаций с `SZCompletion === 100`
   - Обновляет поле `total` в вашей системе
   - Если СМР не найден - оставляет `total = 0` (можно редактировать вручную)

## Структура данных API Айконы

```json
{
  "ObjectId": 401,
  "ObjectName": "ЖК \"Univer city\" 11 очередь, кад. 1515, уч. 12",
  "STKs": [
    {
      "STKId": 114502,
      "STKName": "СТК. Утеплитель \"мокрого\" фасада (с лесов)",
      "Locations": [
        {
          "LocationId": 209421,
          "SZCompletion": 100,  // 100 = выполнено
          ...
        }
      ]
    }
  ]
}
```

## Важные моменты

1. **Сопоставление СМР:**
   - Используется точное совпадение названий
   - Учитываются экранированные кавычки (`\"` → `"`)
   - Названия должны совпадать полностью (например, "СТК. Внутренние стены" должно точно совпадать с названием в Айконе)

2. **Подсчет выполненных работ:**
   - Считаются только локации с `SZCompletion === 100`
   - Если локации нет или `SZCompletion !== 100` - она не считается

3. **Обработка ошибок:**
   - Если объект не найден → "Объект с таким ID не найден в Айконе"
   - Если API недоступно → "API Айконы недоступно"
   - Если ID не указан → "Необходимо указать ID объекта в Айконе"

## Следующие шаги (после тестирования)

1. После успешного тестирования можно скрыть кнопку "Забрать данные"
2. Настроить автоматическое обновление в 7:00 утра через cron job
3. Возможно, добавить логирование синхронизаций

## Тестирование

1. Создайте/откройте объект "Универ сити"
2. Введите ID: `401`
3. Добавьте несколько СМР с точными названиями, как в Айконе (например, "СТК. Утеплитель \"мокрого\" фасада (с лесов)")
4. Нажмите "Забрать данные"
5. Проверьте, что поле `total` обновилось для каждого найденного СМР

